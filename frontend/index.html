<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Admin - Seguros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        
        /* Sidebar Lateral */
        .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #343a40; color: white; padding-top: 20px; }
        .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 1.1rem; color: #adb5bd; display: block; }
        .sidebar a:hover, .sidebar a.active { color: white; background-color: #0d6efd; }
        .sidebar i { width: 25px; }
        
        /* Conte√∫do Principal */
        .main-content { margin-left: 250px; padding: 20px; }
        
        /* Cards de M√©tricas */
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        
        /* Tabela Profissional */
        .table-responsive { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .status-select { border: none; font-size: 0.85rem; font-weight: bold; padding: 5px 10px; border-radius: 20px; cursor: pointer; }
        .status-NOVO { background-color: #cff4fc; color: #055160; }
        .status-NEGOCIACAO { background-color: #fff3cd; color: #856404; }
        .status-FECHADO { background-color: #d1e7dd; color: #0f5132; }
        .status-PERDIDO { background-color: #f8d7da; color: #842029; }

        /* Ajuste para Mobile */
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: relative; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>

    <div class="sidebar d-none d-md-block">
        <h4 class="text-center mb-4"><i class="fas fa-shield-alt"></i> CRM Admin</h4>
        <a href="#" class="active"><i class="fas fa-chart-line"></i> Dashboard</a>
        <a href="#"><i class="fas fa-users"></i> Leads</a>
        <a href="#"><i class="fas fa-bullhorn"></i> Campanhas</a>
        <a href="#" onclick="carregarLeads()"><i class="fas fa-sync"></i> Atualizar</a>
    </div>

    <div class="main-content">
        
        <h3 class="mb-4 text-secondary">Vis√£o Geral</h3>
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div>
                        <h6 class="text-muted">Total Leads</h6>
                        <h3 id="total-leads">0</h3>
                    </div>
                    <div class="stat-icon bg-primary text-white"><i class="fas fa-user-friends"></i></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div>
                        <h6 class="text-muted">Auto</h6>
                        <h3 id="total-auto">0</h3>
                    </div>
                    <div class="stat-icon bg-info text-white"><i class="fas fa-car"></i></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div>
                        <h6 class="text-muted">Vida/Sa√∫de</h6>
                        <h3 id="total-vida">0</h3>
                    </div>
                    <div class="stat-icon bg-danger text-white"><i class="fas fa-heartbeat"></i></div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="table-responsive h-100">
                    <h5 class="mb-3">Distribui√ß√£o por Seguro</h5>
                    <canvas id="graficoLeads"></canvas>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="table-responsive">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Gerenciamento de Leads</h5>
                        <input type="text" id="busca" class="form-control w-25" placeholder="Buscar nome..." onkeyup="filtrarTabela()">
                    </div>
                    
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>Contato</th>
                                <th>Status (Gest√£o)</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-leads">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üëá SEU LINK DO RENDER AQUI üëá
        const API_URL = 'https://crm-seguros.onrender.com/leads'; 
        
        let allLeads = [];
        let chartInstance = null;

        async function carregarLeads() {
            try {
                const res = await fetch(API_URL);
                allLeads = await res.json();
                
                atualizarMetricas();
                renderizarTabela(allLeads);
                renderizarGrafico();
            } catch (error) {
                console.error("Erro ao carregar", error);
                alert("Erro ao conectar com o servidor.");
            }
        }

        function atualizarMetricas() {
            document.getElementById('total-leads').innerText = allLeads.length;
            document.getElementById('total-auto').innerText = allLeads.filter(l => (l.tipo_seguro||'').includes('Auto')).length;
            document.getElementById('total-vida').innerText = allLeads.filter(l => (l.tipo_seguro||'').match(/Vida|Saude/i)).length;
        }

        function renderizarTabela(leads) {
            const tbody = document.getElementById('tabela-leads');
            tbody.innerHTML = '';

            leads.forEach(lead => {
                const status = lead.status || 'NOVO';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="fw-bold">${lead.nome}</div>
                        <small class="text-muted" style="font-size:11px">${new Date(lead.criadoEm).toLocaleDateString()}</small>
                    </td>
                    <td><span class="badge bg-secondary">${lead.tipo_seguro || '-'}</span></td>
                    <td>
                        <a href="https://wa.me/55${lead.whatsapp.replace(/\D/g,'')}" target="_blank" class="text-success text-decoration-none fw-bold">
                            <i class="fab fa-whatsapp"></i> Whats
                        </a>
                    </td>
                    <td>
                        <select class="status-select status-${status}" onchange="mudarStatus(${lead.id}, this)">
                            <option value="NOVO" ${status==='NOVO'?'selected':''}>Novo</option>
                            <option value="NEGOCIACAO" ${status==='NEGOCIACAO'?'selected':''}>Em Negocia√ß√£o</option>
                            <option value="FECHADO" ${status==='FECHADO'?'selected':''}>Venda Fechada</option>
                            <option value="PERDIDO" ${status==='PERDIDO'?'selected':''}>Perdido</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="verDetalhes('${lead.nome}', '${lead.obs_final || ''}', '${lead.modelo_veiculo || ''}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletarLead(${lead.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function mudarStatus(id, selectElement) {
            const novoStatus = selectElement.value;
            // Muda a cor visualmente na hora
            selectElement.className = `status-select status-${novoStatus}`;
            
            // Atualiza no banco
            await fetch(`${API_URL}/${id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ status: novoStatus })
            });
        }

        async function deletarLead(id) {
            if(confirm('Tem certeza que deseja EXCLUIR este lead?')) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                carregarLeads(); // Recarrega a lista
            }
        }

        function renderizarGrafico() {
            const ctx = document.getElementById('graficoLeads').getContext('2d');
            
            // Contagem para o gr√°fico
            const auto = allLeads.filter(l => (l.tipo_seguro||'').includes('Auto')).length;
            const vida = allLeads.filter(l => (l.tipo_seguro||'').includes('Vida')).length;
            const saude = allLeads.filter(l => (l.tipo_seguro||'').includes('Saude')).length;
            const outros = allLeads.length - (auto + vida + saude);

            if(chartInstance) chartInstance.destroy(); // Limpa anterior

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Auto', 'Vida', 'Sa√∫de', 'Outros'],
                    datasets: [{
                        data: [auto, vida, saude, outros],
                        backgroundColor: ['#36a2eb', '#ff6384', '#4bc0c0', '#ffcd56']
                    }]
                }
            });
        }

        function verDetalhes(nome, obs, veiculo) {
            alert(`Detalhes de ${nome}:\nVe√≠culo: ${veiculo}\nObs: ${obs}`);
        }

        function filtrarTabela() {
            const termo = document.getElementById('busca').value.toLowerCase();
            const filtrados = allLeads.filter(l => l.nome.toLowerCase().includes(termo));
            renderizarTabela(filtrados);
        }

        // Iniciar
        carregarLeads();
    </script>
</body>
</html>