generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTENTICAÇÃO - Usuários e Assinaturas
// ============================================

model User {
  id                Int       @id @default(autoincrement())
  email             String    @unique
  password          String
  name              String
  role              String    @default("user") // user, admin, superadmin
  stripeCustomerId  String?   @unique
  
  // Relações Multi-Tenant
  subscription      Subscription?
  config            Config?
  leads             Lead[]
  policies          Policy[]
  conversations     Conversation[]
  campaigns         Campaign[]
  templates         Template[]
  posts             Post[]
  trafficData       TrafficData[]
  activities        Activity[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Subscription {
  id                     Int       @id @default(autoincrement())
  userId                 Int       @unique
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  plan                   String    @default("free") // free, basic, pro, enterprise
  status                 String    @default("inactive") // active, canceled, past_due, trialing
  
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
}

// ============================================
// LEADS - Multi-Tenant
// ============================================

model Lead {
  id        Int      @id @default(autoincrement())
  userId    Int      // Multi-tenant
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  criadoEm  DateTime @default(now())
  
  nome                String
  whatsapp            String
  email               String?
  cpf                 String?
  status              String   @default("NOVO")
  
  tipo_seguro         String?
  placa               String?
  modelo_veiculo      String?
  ano_veiculo         String?
  uso_veiculo         String?

  link_pasta          String?
  dados_extras        Json?
  
  @@index([userId])
}

// ============================================
// CONFIGURAÇÕES - Por Usuário (Multi-Tenant)
// ============================================

model Config {
  id                  Int      @id @default(autoincrement())
  userId              Int      @unique // Uma config por usuário
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  promo_folder_link   String?
  message_header      String?
  broker_name         String?  @default("CRM Seguros")
  primary_color       String?  @default("#0f172a")
  logo_url            String?
  
  // Configurações de integração
  evolutionApiUrl     String?
  evolutionApiKey     String?
  n8nWebhookUrl       String?
  
  updatedAt           DateTime @updatedAt
}

// ============================================
// INBOX - Mensagens WhatsApp (Multi-Tenant)
// ============================================

model Conversation {
  id          Int       @id @default(autoincrement())
  userId      Int       // Multi-tenant
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  remoteJid   String    // Número WhatsApp
  name        String?
  phone       String
  avatarUrl   String?
  isOnline    Boolean   @default(false)
  unreadCount Int       @default(0)
  lastMessage String?
  lastMessageAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  messages    Message[]
  
  @@unique([userId, remoteJid]) // Único por usuário+contato
  @@index([userId])
}

model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  messageId      String?      // ID da mensagem do WhatsApp
  text           String
  isFromMe       Boolean      @default(false)
  status         String       @default("sent")
  timestamp      DateTime     @default(now())
  
  createdAt      DateTime     @default(now())
  
  @@index([conversationId])
}

// ============================================
// MARKETING - Campanhas e Templates (Multi-Tenant)
// ============================================

model Campaign {
  id          Int       @id @default(autoincrement())
  userId      Int       // Multi-tenant
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  type        String
  status      String    @default("active")
  startDate   DateTime
  endDate     DateTime?
  
  views       Int       @default(0)
  engagement  Float     @default(0)
  leads       Int       @default(0)
  
  imageUrl    String?
  description String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([userId])
}

model Template {
  id          Int       @id @default(autoincrement())
  userId      Int       // Multi-tenant
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  category    String
  icon        String?
  gradient    String?
  content     String?
  imageUrl    String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([userId])
}

// ============================================
// SERVIÇOS - Posts e Tráfego (Multi-Tenant)
// ============================================

model Post {
  id          Int       @id @default(autoincrement())
  userId      Int       // Multi-tenant
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  content     String?
  platform    String
  status      String    @default("draft")
  scheduledAt DateTime?
  publishedAt DateTime?
  
  views       Int       @default(0)
  likes       Int       @default(0)
  shares      Int       @default(0)
  
  imageUrl    String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([userId])
}

model TrafficData {
  id            Int       @id @default(autoincrement())
  userId        Int       // Multi-tenant
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  platform      String
  period        String
  
  spend         Float     @default(0)
  clicks        Int       @default(0)
  impressions   Int       @default(0)
  ctr           Float     @default(0)
  conversions   Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([userId, platform, period])
  @@index([userId])
}

model Activity {
  id          Int       @id @default(autoincrement())
  userId      Int       // Multi-tenant
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action      String
  icon        String?
  color       String?
  relatedId   Int?
  relatedType String?
  
  createdAt   DateTime  @default(now())
  
  @@index([userId])
}

// ============================================
// APÓLICES - Gestão de Seguros (Multi-Tenant)
// ============================================

model Policy {
  id              Int       @id @default(autoincrement())
  userId          Int       // Multi-tenant
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  policyNumber    String    // Número da apólice (único por usuário)
  
  // Segurado
  holderName      String
  holderCpf       String
  holderPhone     String
  holderEmail     String?
  
  // Tipo e Status
  type            String
  status          String    @default("active")
  
  // Valores
  premium         Float
  coverage        Float
  deductible      Float?
  
  // Datas
  startDate       DateTime
  endDate         DateTime
  paymentDueDay   Int?
  
  // Seguradora
  insurerName     String
  insurerCode     String?
  
  // Veículo (seguro auto)
  vehiclePlate    String?
  vehicleModel    String?
  vehicleYear     String?
  
  // Imóvel (residencial)
  propertyAddress String?
  propertyType    String?
  
  // Documentos
  documentUrl     String?
  notes           String?
  
  // Relacionamento com Lead
  leadId          Int?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([userId, policyNumber])
  @@index([userId])
}